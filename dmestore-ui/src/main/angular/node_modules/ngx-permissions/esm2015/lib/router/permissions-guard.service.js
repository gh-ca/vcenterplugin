import { Injectable } from '@angular/core';
import { Router } from '@angular/router';
import { forkJoin, from, of } from 'rxjs';
import { first, mergeMap, tap } from 'rxjs/operators';
import { DEFAULT_REDIRECT_KEY } from '../model/permissions-router-data.model';
import { NgxPermissionsService } from '../service/permissions.service';
import { NgxRolesService } from '../service/roles.service';
import { isFunction, isPlainObject, transformStringToArray } from '../utils/utils';
export class NgxPermissionsGuard {
    constructor(permissionsService, rolesService, router) {
        this.permissionsService = permissionsService;
        this.rolesService = rolesService;
        this.router = router;
    }
    canActivate(route, state) {
        return this.hasPermissions(route, state);
    }
    canActivateChild(childRoute, state) {
        return this.hasPermissions(childRoute, state);
    }
    canLoad(route) {
        return this.hasPermissions(route);
    }
    hasPermissions(route, state) {
        const routeDataPermissions = !!route && route.data ? route.data.permissions : {};
        const permissions = this.transformPermission(routeDataPermissions, route, state);
        if (this.isParameterAvailable(permissions.except)) {
            return this.passingExceptPermissionsValidation(permissions, route, state);
        }
        if (this.isParameterAvailable(permissions.only)) {
            return this.passingOnlyPermissionsValidation(permissions, route, state);
        }
        return true;
    }
    transformPermission(permissions, route, state) {
        const only = isFunction(permissions.only)
            ? permissions.only(route, state)
            : transformStringToArray(permissions.only);
        const except = isFunction(permissions.except)
            ? permissions.except(route, state)
            : transformStringToArray(permissions.except);
        const redirectTo = permissions.redirectTo;
        return {
            only,
            except,
            redirectTo
        };
    }
    isParameterAvailable(permission) {
        return !!permission && permission.length > 0;
    }
    passingExceptPermissionsValidation(permissions, route, state) {
        if (!!permissions.redirectTo
            && ((isFunction(permissions.redirectTo))
                || (isPlainObject(permissions.redirectTo) && !this.isRedirectionWithParameters(permissions.redirectTo)))) {
            let failedPermission = '';
            return from(permissions.except)
                .pipe(mergeMap(permissionsExcept => {
                return forkJoin([
                    this.permissionsService.hasPermission(permissionsExcept),
                    this.rolesService.hasOnlyRoles(permissionsExcept)
                ]).pipe(tap(hasPermissions => {
                    const dontHavePermissions = hasPermissions.every(hasPermission => hasPermission === false);
                    if (!dontHavePermissions) {
                        failedPermission = permissionsExcept;
                    }
                }));
            }), first(hasPermissions => hasPermissions.some(hasPermission => hasPermission === true), false), mergeMap(isAllFalse => {
                if (!!failedPermission) {
                    this.handleRedirectOfFailedPermission(permissions, failedPermission, route, state);
                    return of(false);
                }
                if (!isAllFalse && permissions.only) {
                    return this.onlyRedirectCheck(permissions, route, state);
                }
                return of(!isAllFalse);
            }))
                .toPromise();
        }
        return Promise.all([
            this.permissionsService.hasPermission(permissions.except),
            this.rolesService.hasOnlyRoles(permissions.except)
        ]).then(([hasPermission, hasRoles]) => {
            if (hasPermission || hasRoles) {
                if (permissions.redirectTo) {
                    this.redirectToAnotherRoute(permissions.redirectTo, route, state);
                }
                return false;
            }
            if (permissions.only) {
                return this.checkOnlyPermissions(permissions, route, state);
            }
            return true;
        });
    }
    redirectToAnotherRoute(permissionRedirectTo, route, state, failedPermissionName) {
        const redirectTo = isFunction(permissionRedirectTo)
            ? permissionRedirectTo(failedPermissionName, route, state)
            : permissionRedirectTo;
        if (this.isRedirectionWithParameters(redirectTo)) {
            redirectTo.navigationCommands = this.transformNavigationCommands(redirectTo.navigationCommands, route, state);
            redirectTo.navigationExtras = this.transformNavigationExtras(redirectTo.navigationExtras, route, state);
            this.router.navigate(redirectTo.navigationCommands, redirectTo.navigationExtras);
            return;
        }
        if (Array.isArray(redirectTo)) {
            this.router.navigate(redirectTo);
        }
        else {
            this.router.navigate([redirectTo]);
        }
    }
    isRedirectionWithParameters(object) {
        return (isPlainObject(object) && (!!object.navigationCommands || !!object.navigationExtras));
    }
    transformNavigationCommands(navigationCommands, route, state) {
        return isFunction(navigationCommands)
            ? navigationCommands(route, state)
            : navigationCommands;
    }
    transformNavigationExtras(navigationExtras, route, state) {
        return isFunction(navigationExtras)
            ? navigationExtras(route, state)
            : navigationExtras;
    }
    onlyRedirectCheck(permissions, route, state) {
        let failedPermission = '';
        return from(permissions.only)
            .pipe(mergeMap(permissionsOnly => {
            return forkJoin([
                this.permissionsService.hasPermission(permissionsOnly),
                this.rolesService.hasOnlyRoles(permissionsOnly)
            ]).pipe(tap(hasPermissions => {
                const failed = hasPermissions.every(hasPermission => hasPermission === false);
                if (failed) {
                    failedPermission = permissionsOnly;
                }
            }));
        }), first(hasPermissions => {
            if (isFunction(permissions.redirectTo)) {
                return hasPermissions.some(hasPermission => hasPermission === true);
            }
            return hasPermissions.every(hasPermission => hasPermission === false);
        }, false), mergeMap((pass) => {
            if (isFunction(permissions.redirectTo)) {
                if (pass) {
                    return of(true);
                }
                else {
                    this.handleRedirectOfFailedPermission(permissions, failedPermission, route, state);
                    return of(false);
                }
            }
            else {
                if (!!failedPermission) {
                    this.handleRedirectOfFailedPermission(permissions, failedPermission, route, state);
                }
                return of(!pass);
            }
        }))
            .toPromise();
    }
    handleRedirectOfFailedPermission(permissions, failedPermission, route, state) {
        if (this.isFailedPermissionPropertyOfRedirectTo(permissions, failedPermission)) {
            this.redirectToAnotherRoute(permissions.redirectTo[failedPermission], route, state, failedPermission);
        }
        else {
            if (isFunction(permissions.redirectTo)) {
                this.redirectToAnotherRoute(permissions.redirectTo, route, state, failedPermission);
            }
            else {
                this.redirectToAnotherRoute(permissions.redirectTo[DEFAULT_REDIRECT_KEY], route, state, failedPermission);
            }
        }
    }
    isFailedPermissionPropertyOfRedirectTo(permissions, failedPermission) {
        return (!!permissions.redirectTo && permissions.redirectTo[failedPermission]);
    }
    checkOnlyPermissions(purePermissions, route, state) {
        const permissions = Object.assign({}, purePermissions);
        return Promise.all([
            this.permissionsService.hasPermission(permissions.only),
            this.rolesService.hasOnlyRoles(permissions.only)
        ]).then(([hasPermission, hasRole]) => {
            if (hasPermission || hasRole) {
                return true;
            }
            if (permissions.redirectTo) {
                this.redirectToAnotherRoute(permissions.redirectTo, route, state);
            }
            return false;
        });
    }
    passingOnlyPermissionsValidation(permissions, route, state) {
        if ((isFunction(permissions.redirectTo)
            || isPlainObject(permissions.redirectTo) && !this.isRedirectionWithParameters(permissions.redirectTo))) {
            return this.onlyRedirectCheck(permissions, route, state);
        }
        return this.checkOnlyPermissions(permissions, route, state);
    }
}
NgxPermissionsGuard.decorators = [
    { type: Injectable }
];
NgxPermissionsGuard.ctorParameters = () => [
    { type: NgxPermissionsService },
    { type: NgxRolesService },
    { type: Router }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbnMtZ3VhcmQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1wZXJtaXNzaW9ucy9zcmMvbGliL3JvdXRlci9wZXJtaXNzaW9ucy1ndWFyZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQU9ILE1BQU0sRUFFVCxNQUFNLGlCQUFpQixDQUFDO0FBRXpCLE9BQU8sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0RCxPQUFPLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV0RCxPQUFPLEVBQ0gsb0JBQW9CLEVBU3ZCLE1BQU0sd0NBQXdDLENBQUM7QUFDaEQsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDdkUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzNELE9BQU8sRUFBRSxVQUFVLEVBQUUsYUFBYSxFQUFFLHNCQUFzQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFTbkYsTUFBTSxPQUFPLG1CQUFtQjtJQUU1QixZQUFvQixrQkFBeUMsRUFBVSxZQUE2QixFQUFVLE1BQWM7UUFBeEcsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUF1QjtRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUFpQjtRQUFVLFdBQU0sR0FBTixNQUFNLENBQVE7SUFDNUgsQ0FBQztJQUVELFdBQVcsQ0FBQyxLQUE2QixFQUFFLEtBQTBCO1FBQ2pFLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVELGdCQUFnQixDQUFDLFVBQWtDLEVBQUUsS0FBMEI7UUFDM0UsT0FBTyxJQUFJ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Q0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUM7U0FDbkQsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxFQUFFLEVBQUU7WUFDakMsSUFBSSxhQUFhLElBQUksT0FBTyxFQUFFO2dCQUMxQixPQUFPLElBQUksQ0FBQzthQUNmO1lBRUQsSUFBSSxXQUFXLENBQUMsVUFBVSxFQUFFO2dCQUN4QixJQUFJLENBQUMsc0JBQXNCLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7YUFDckU7WUFFRCxPQUFPLEtBQUssQ0FBQztRQUNqQixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTyxnQ0FBZ0MsQ0FDcEMsV0FBK0IsRUFDL0IsS0FBcUMsRUFDckMsS0FBMkI7UUFFM0IsSUFDSSxDQUFDLFVBQVUsQ0FBZSxXQUFXLENBQUMsVUFBVSxDQUFDO2VBQzFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsMkJBQTJCLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQzVHO1lBQ0UsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsV0FBVyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztTQUM1RDtRQUNELE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLFdBQVcsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDaEUsQ0FBQzs7O1lBaFNKLFVBQVU7OztZQVZGLHFCQUFxQjtZQUNyQixlQUFlO1lBbkJwQixNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgICBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LFxuICAgIENhbkFjdGl2YXRlLFxuICAgIENhbkFjdGl2YXRlQ2hpbGQsXG4gICAgQ2FuTG9hZCxcbiAgICBOYXZpZ2F0aW9uRXh0cmFzLFxuICAgIFJvdXRlLFxuICAgIFJvdXRlcixcbiAgICBSb3V0ZXJTdGF0ZVNuYXBzaG90XG59IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5cbmltcG9ydCB7IGZvcmtKb2luLCBmcm9tLCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlyc3QsIG1lcmdlTWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7XG4gICAgREVGQVVMVF9SRURJUkVDVF9LRVksXG4gICAgRXhjZXB0Rm4sXG4gICAgTmF2aWdhdGlvbkNvbW1hbmRzRm4sXG4gICAgTmF2aWdhdGlvbkV4dHJhc0ZuLFxuICAgIE5neFBlcm1pc3Npb25zUm91dGVyRGF0YSxcbiAgICBOZ3hSZWRpcmVjdFRvTmF2aWdhdGlvblBhcmFtZXRlcnMsXG4gICAgT25seUZuLFxuICAgIFJlZGlyZWN0VG8sXG4gICAgUmVkaXJlY3RUb0ZuXG59IGZyb20gJy4uL21vZGVsL3Blcm1pc3Npb25zLXJvdXRlci1kYXRhLm1vZGVsJztcbmltcG9ydCB7IE5neFBlcm1pc3Npb25zU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2UvcGVybWlzc2lvbnMuc2VydmljZSc7XG5pbXBvcnQgeyBOZ3hSb2xlc1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlL3JvbGVzLnNlcnZpY2UnO1xuaW1wb3J0IHsgaXNGdW5jdGlvbiwgaXNQbGFpbk9iamVjdCwgdHJhbnNmb3JtU3RyaW5nVG9BcnJheSB9IGZyb20gJy4uL3V0aWxzL3V0aWxzJztcblxuZXhwb3J0IGludGVyZmFjZSBOZ3hQZXJtaXNzaW9uc0RhdGEge1xuICAgIG9ubHk/OiBzdHJpbmcgfCBzdHJpbmdbXTtcbiAgICBleGNlcHQ/OiBzdHJpbmcgfCBzdHJpbmdbXTtcbiAgICByZWRpcmVjdFRvPzogUmVkaXJlY3RUbyB8IFJlZGlyZWN0VG9Gbjtcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5neFBlcm1pc3Npb25zR3VhcmQgaW1wbGVtZW50cyBDYW5BY3RpdmF0ZSwgQ2FuTG9hZCwgQ2FuQWN0aXZhdGVDaGlsZCB7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHBlcm1pc3Npb25zU2VydmljZTogTmd4UGVybWlzc2lvbnNTZXJ2aWNlLCBwcml2YXRlIHJvbGVzU2VydmljZTogTmd4Um9sZXNTZXJ2aWNlLCBwcml2YXRlIHJvdXRlcjogUm91dGVyKSB7XG4gICAgfVxuXG4gICAgY2FuQWN0aXZhdGUocm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIHN0YXRlOiBSb3V0ZXJTdGF0ZVNuYXBzaG90KTogUHJvbWlzZTxib29sZWFuPiB8IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNQZXJtaXNzaW9ucyhyb3V0ZSwgc3RhdGUpO1xuICAgIH1cblxuICAgIGNhbkFjdGl2YXRlQ2hpbGQoY2hpbGRSb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgc3RhdGU6IFJvdXRlclN0YXRlU25hcHNob3QpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHwgUHJvbWlzZTxib29sZWFuPiB8IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNQZXJtaXNzaW9ucyhjaGlsZFJvdXRlLCBzdGF0ZSk7XG4gICAgfVxuXG4gICAgY2FuTG9hZChyb3V0ZTogUm91dGUpOiBib29sZWFuIHwgT2JzZXJ2YWJsZTxib29sZWFuPiB8IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNQZXJtaXNzaW9ucyhyb3V0ZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYXNQZXJtaXNzaW9ucyhyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLCBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3QpIHtcbiAgICAgICAgY29uc3Qgcm91dGVEYXRhUGVybWlzc2lvbnMgPSAhIXJvdXRlICYmIHJvdXRlLmRhdGEgPyAocm91dGUuZGF0YS5wZXJtaXNzaW9ucyBhcyBOZ3hQZXJtaXNzaW9uc1JvdXRlckRhdGEpIDoge307XG4gICAgICAgIGNvbnN0IHBlcm1pc3Npb25zID0gdGhpcy50cmFuc2Zvcm1QZXJtaXNzaW9uKHJvdXRlRGF0YVBlcm1pc3Npb25zLCByb3V0ZSwgc3RhdGUpO1xuXG4gICAgICAgIGlmICh0aGlzLmlzUGFyYW1ldGVyQXZhaWxhYmxlKHBlcm1pc3Npb25zLmV4Y2VwdCkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhc3NpbmdFeGNlcHRQZXJtaXNzaW9uc1ZhbGlkYXRpb24ocGVybWlzc2lvbnMsIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5pc1BhcmFtZXRlckF2YWlsYWJsZShwZXJtaXNzaW9ucy5vbmx5KSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFzc2luZ09ubHlQZXJtaXNzaW9uc1ZhbGlkYXRpb24ocGVybWlzc2lvbnMsIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHRyYW5zZm9ybVBlcm1pc3Npb24oXG4gICAgICAgIHBlcm1pc3Npb25zOiBOZ3hQZXJtaXNzaW9uc1JvdXRlckRhdGEsXG4gICAgICAgIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90IHwgUm91dGUsXG4gICAgICAgIHN0YXRlPzogUm91dGVyU3RhdGVTbmFwc2hvdFxuICAgICk6IE5neFBlcm1pc3Npb25zRGF0YSB7XG4gICAgICAgIGNvbnN0IG9ubHkgPSBpc0Z1bmN0aW9uPE9ubHlGbj4ocGVybWlzc2lvbnMub25seSlcbiAgICAgICAgICAgID8gcGVybWlzc2lvbnMub25seShyb3V0ZSwgc3RhdGUpXG4gICAgICAgICAgICA6IHRyYW5zZm9ybVN0cmluZ1RvQXJyYXkocGVybWlzc2lvbnMub25seSk7XG4gICAgICAgIGNvbnN0IGV4Y2VwdCA9IGlzRnVuY3Rpb248RXhjZXB0Rm4+KHBlcm1pc3Npb25zLmV4Y2VwdClcbiAgICAgICAgICAgID8gcGVybWlzc2lvbnMuZXhjZXB0KHJvdXRlLCBzdGF0ZSlcbiAgICAgICAgICAgIDogdHJhbnNmb3JtU3RyaW5nVG9BcnJheShwZXJtaXNzaW9ucy5leGNlcHQpO1xuICAgICAgICBjb25zdCByZWRpcmVjdFRvID0gcGVybWlzc2lvbnMucmVkaXJlY3RUbztcblxuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBvbmx5LFxuICAgICAgICAgICAgZXhjZXB0LFxuICAgICAgICAgICAgcmVkaXJlY3RUb1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNQYXJhbWV0ZXJBdmFpbGFibGUocGVybWlzc2lvbjogc3RyaW5nIHwgc3RyaW5nW10pIHtcbiAgICAgICAgcmV0dXJuICEhcGVybWlzc2lvbiAmJiBwZXJtaXNzaW9uLmxlbmd0aCA+IDA7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwYXNzaW5nRXhjZXB0UGVybWlzc2lvbnNWYWxpZGF0aW9uKFxuICAgICAgICBwZXJtaXNzaW9uczogTmd4UGVybWlzc2lvbnNEYXRhLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZTogUm91dGVyU3RhdGVTbmFwc2hvdFxuICAgICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICAhIXBlcm1pc3Npb25zLnJlZGlyZWN0VG9cbiAgICAgICAgICAgICYmIChcbiAgICAgICAgICAgICAgICAoaXNGdW5jdGlvbjxSZWRpcmVjdFRvRm4+KHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pKVxuICAgICAgICAgICAgICAgIHx8IChpc1BsYWluT2JqZWN0KHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pICYmICF0aGlzLmlzUmVkaXJlY3Rpb25XaXRoUGFyYW1ldGVycyhwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKSlcbiAgICAgICAgICAgIClcbiAgICAgICAgKSB7XG4gICAgICAgICAgICBsZXQgZmFpbGVkUGVybWlzc2lvbiA9ICcnO1xuXG4gICAgICAgICAgICByZXR1cm4gZnJvbShwZXJtaXNzaW9ucy5leGNlcHQpXG4gICAgICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgIG1lcmdlTWFwKHBlcm1pc3Npb25zRXhjZXB0ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmb3JrSm9pbihbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJtaXNzaW9uc1NlcnZpY2UuaGFzUGVybWlzc2lvbihwZXJtaXNzaW9uc0V4Y2VwdCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yb2xlc1NlcnZpY2UuaGFzT25seVJvbGVzKHBlcm1pc3Npb25zRXhjZXB0KVxuICAgICAgICAgICAgICAgICAgICAgICAgXSkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXAoaGFzUGVybWlzc2lvbnMgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkb250SGF2ZVBlcm1pc3Npb25zID0gaGFzUGVybWlzc2lvbnMuZXZlcnkoaGFzUGVybWlzc2lvbiA9PiBoYXNQZXJtaXNzaW9uID09PSBmYWxzZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkb250SGF2ZVBlcm1pc3Npb25zKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWRQZXJtaXNzaW9uID0gcGVybWlzc2lvbnNFeGNlcHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgICAgIGZpcnN0KGhhc1Blcm1pc3Npb25zID0+IGhhc1Blcm1pc3Npb25zLnNvbWUoaGFzUGVybWlzc2lvbiA9PiBoYXNQZXJtaXNzaW9uID09PSB0cnVlKSwgZmFsc2UpLFxuICAgICAgICAgICAgICAgICAgICBtZXJnZU1hcChpc0FsbEZhbHNlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghIWZhaWxlZFBlcm1pc3Npb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVJlZGlyZWN0T2ZGYWlsZWRQZXJtaXNzaW9uKHBlcm1pc3Npb25zLCBmYWlsZWRQZXJtaXNzaW9uLCByb3V0ZSwgc3RhdGUpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0FsbEZhbHNlICYmIHBlcm1pc3Npb25zLm9ubHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vbmx5UmVkaXJlY3RDaGVjayhwZXJtaXNzaW9ucywgcm91dGUsIHN0YXRlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKCFpc0FsbEZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgLnRvUHJvbWlzZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgIHRoaXMucGVybWlzc2lvbnNTZXJ2aWNlLmhhc1Blcm1pc3Npb24ocGVybWlzc2lvbnMuZXhjZXB0KSxcbiAgICAgICAgICAgIHRoaXMucm9sZXNTZXJ2aWNlLmhhc09ubHlSb2xlcyhwZXJtaXNzaW9ucy5leGNlcHQpXG4gICAgICAgIF0pLnRoZW4oKFtoYXNQZXJtaXNzaW9uLCBoYXNSb2xlc10pID0+IHtcbiAgICAgICAgICAgIGlmIChoYXNQZXJtaXNzaW9uIHx8IGhhc1JvbGVzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWRpcmVjdFRvQW5vdGhlclJvdXRlKFxuICAgICAgICAgICAgICAgICAgICAgICAgcGVybWlzc2lvbnMucmVkaXJlY3RUbyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvdXRlLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChwZXJtaXNzaW9ucy5vbmx5KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hlY2tPbmx5UGVybWlzc2lvbnMocGVybWlzc2lvbnMsIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZWRpcmVjdFRvQW5vdGhlclJvdXRlKFxuICAgICAgICBwZXJtaXNzaW9uUmVkaXJlY3RUbzogUmVkaXJlY3RUbyB8IFJlZGlyZWN0VG9GbixcbiAgICAgICAgcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgfCBSb3V0ZSxcbiAgICAgICAgc3RhdGU/OiBSb3V0ZXJTdGF0ZVNuYXBzaG90LFxuICAgICAgICBmYWlsZWRQZXJtaXNzaW9uTmFtZT86IHN0cmluZ1xuICAgICk6IHZvaWQge1xuXG4gICAgICAgIGNvbnN0IHJlZGlyZWN0VG8gPSBpc0Z1bmN0aW9uPFJlZGlyZWN0VG9Gbj4ocGVybWlzc2lvblJlZGlyZWN0VG8pXG4gICAgICAgICAgICA/IHBlcm1pc3Npb25SZWRpcmVjdFRvKGZhaWxlZFBlcm1pc3Npb25OYW1lLCByb3V0ZSwgc3RhdGUpXG4gICAgICAgICAgICA6IHBlcm1pc3Npb25SZWRpcmVjdFRvO1xuXG4gICAgICAgIGlmICh0aGlzLmlzUmVkaXJlY3Rpb25XaXRoUGFyYW1ldGVycyhyZWRpcmVjdFRvKSkge1xuICAgICAgICAgICAgcmVkaXJlY3RUby5uYXZpZ2F0aW9uQ29tbWFuZHMgPSB0aGlzLnRyYW5zZm9ybU5hdmlnYXRpb25Db21tYW5kcyhyZWRpcmVjdFRvLm5hdmlnYXRpb25Db21tYW5kcywgcm91dGUsIHN0YXRlKTtcbiAgICAgICAgICAgIHJlZGlyZWN0VG8ubmF2aWdhdGlvbkV4dHJhcyA9IHRoaXMudHJhbnNmb3JtTmF2aWdhdGlvbkV4dHJhcyhyZWRpcmVjdFRvLm5hdmlnYXRpb25FeHRyYXMsIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShyZWRpcmVjdFRvLm5hdmlnYXRpb25Db21tYW5kcywgcmVkaXJlY3RUby5uYXZpZ2F0aW9uRXh0cmFzKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlZGlyZWN0VG8pKSB7XG4gICAgICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShyZWRpcmVjdFRvKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFtyZWRpcmVjdFRvXSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGlzUmVkaXJlY3Rpb25XaXRoUGFyYW1ldGVycyhvYmplY3Q6IGFueSB8IE5neFJlZGlyZWN0VG9OYXZpZ2F0aW9uUGFyYW1ldGVycyk6IG9iamVjdCBpcyBOZ3hSZWRpcmVjdFRvTmF2aWdhdGlvblBhcmFtZXRlcnMge1xuICAgICAgICByZXR1cm4gKGlzUGxhaW5PYmplY3Qob2JqZWN0KSAmJiAoISFvYmplY3QubmF2aWdhdGlvbkNvbW1hbmRzIHx8ICEhb2JqZWN0Lm5hdmlnYXRpb25FeHRyYXMpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHRyYW5zZm9ybU5hdmlnYXRpb25Db21tYW5kcyhcbiAgICAgICAgbmF2aWdhdGlvbkNvbW1hbmRzOiBhbnlbXSB8IE5hdmlnYXRpb25Db21tYW5kc0ZuLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3RcbiAgICApOiBhbnlbXSB7XG4gICAgICAgIHJldHVybiBpc0Z1bmN0aW9uPE5hdmlnYXRpb25Db21tYW5kc0ZuPihuYXZpZ2F0aW9uQ29tbWFuZHMpXG4gICAgICAgICAgICA/IG5hdmlnYXRpb25Db21tYW5kcyhyb3V0ZSwgc3RhdGUpXG4gICAgICAgICAgICA6IG5hdmlnYXRpb25Db21tYW5kcztcbiAgICB9XG5cbiAgICBwcml2YXRlIHRyYW5zZm9ybU5hdmlnYXRpb25FeHRyYXMoXG4gICAgICAgIG5hdmlnYXRpb25FeHRyYXM6IE5hdmlnYXRpb25FeHRyYXMgfCBOYXZpZ2F0aW9uRXh0cmFzRm4sXG4gICAgICAgIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90IHwgUm91dGUsXG4gICAgICAgIHN0YXRlPzogUm91dGVyU3RhdGVTbmFwc2hvdFxuICAgICk6IE5hdmlnYXRpb25FeHRyYXMge1xuICAgICAgICByZXR1cm4gaXNGdW5jdGlvbjxOYXZpZ2F0aW9uRXh0cmFzRm4+KG5hdmlnYXRpb25FeHRyYXMpXG4gICAgICAgICAgICA/IG5hdmlnYXRpb25FeHRyYXMocm91dGUsIHN0YXRlKVxuICAgICAgICAgICAgOiBuYXZpZ2F0aW9uRXh0cmFzO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25seVJlZGlyZWN0Q2hlY2soXG4gICAgICAgIHBlcm1pc3Npb25zOiBOZ3hQZXJtaXNzaW9uc0RhdGEsXG4gICAgICAgIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90IHwgUm91dGUsXG4gICAgICAgIHN0YXRlPzogUm91dGVyU3RhdGVTbmFwc2hvdFxuICAgICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBsZXQgZmFpbGVkUGVybWlzc2lvbiA9ICcnO1xuXG4gICAgICAgIHJldHVybiBmcm9tKHBlcm1pc3Npb25zLm9ubHkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtZXJnZU1hcChwZXJtaXNzaW9uc09ubHkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm9ya0pvaW4oW1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJtaXNzaW9uc1NlcnZpY2UuaGFzUGVybWlzc2lvbihwZXJtaXNzaW9uc09ubHkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yb2xlc1NlcnZpY2UuaGFzT25seVJvbGVzKHBlcm1pc3Npb25zT25seSlcbiAgICAgICAgICAgICAgICAgICAgXSkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcChoYXNQZXJtaXNzaW9ucyA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZmFpbGVkID0gaGFzUGVybWlzc2lvbnMuZXZlcnkoaGFzUGVybWlzc2lvbiA9PiBoYXNQZXJtaXNzaW9uID09PSBmYWxzZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmFpbGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZFBlcm1pc3Npb24gPSBwZXJtaXNzaW9uc09ubHk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBmaXJzdChoYXNQZXJtaXNzaW9ucyA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbjxSZWRpcmVjdFRvRm4+KHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhhc1Blcm1pc3Npb25zLnNvbWUoaGFzUGVybWlzc2lvbiA9PiBoYXNQZXJtaXNzaW9uID09PSB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhhc1Blcm1pc3Npb25zLmV2ZXJ5KGhhc1Blcm1pc3Npb24gPT4gaGFzUGVybWlzc2lvbiA9PT0gZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBmYWxzZSksXG4gICAgICAgICAgICAgICAgbWVyZ2VNYXAoXG4gICAgICAgICAgICAgICAgICAgIChwYXNzOiBib29sZWFuKTogT2JzZXJ2YWJsZTxib29sZWFuPiA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbjxSZWRpcmVjdFRvRm4+KHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhc3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlUmVkaXJlY3RPZkZhaWxlZFBlcm1pc3Npb24ocGVybWlzc2lvbnMsIGZhaWxlZFBlcm1pc3Npb24sIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoISFmYWlsZWRQZXJtaXNzaW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlUmVkaXJlY3RPZkZhaWxlZFBlcm1pc3Npb24ocGVybWlzc2lvbnMsIGZhaWxlZFBlcm1pc3Npb24sIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZighcGFzcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAudG9Qcm9taXNlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVSZWRpcmVjdE9mRmFpbGVkUGVybWlzc2lvbihcbiAgICAgICAgcGVybWlzc2lvbnM6IE5neFBlcm1pc3Npb25zRGF0YSxcbiAgICAgICAgZmFpbGVkUGVybWlzc2lvbjogc3RyaW5nLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3RcbiAgICApIHtcbiAgICAgICAgaWYgKHRoaXMuaXNGYWlsZWRQZXJtaXNzaW9uUHJvcGVydHlPZlJlZGlyZWN0VG8ocGVybWlzc2lvbnMsIGZhaWxlZFBlcm1pc3Npb24pKSB7XG4gICAgICAgICAgICB0aGlzLnJlZGlyZWN0VG9Bbm90aGVyUm91dGUocGVybWlzc2lvbnMucmVkaXJlY3RUb1tmYWlsZWRQZXJtaXNzaW9uXSwgcm91dGUsIHN0YXRlLCBmYWlsZWRQZXJtaXNzaW9uKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uPFJlZGlyZWN0VG9Gbj4ocGVybWlzc2lvbnMucmVkaXJlY3RUbykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlZGlyZWN0VG9Bbm90aGVyUm91dGUocGVybWlzc2lvbnMucmVkaXJlY3RUbywgcm91dGUsIHN0YXRlLCBmYWlsZWRQZXJtaXNzaW9uKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWRpcmVjdFRvQW5vdGhlclJvdXRlKHBlcm1pc3Npb25zLnJlZGlyZWN0VG9bREVGQVVMVF9SRURJUkVDVF9LRVldLCByb3V0ZSwgc3RhdGUsIGZhaWxlZFBlcm1pc3Npb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc0ZhaWxlZFBlcm1pc3Npb25Qcm9wZXJ0eU9mUmVkaXJlY3RUbyhwZXJtaXNzaW9uczogTmd4UGVybWlzc2lvbnNEYXRhLCBmYWlsZWRQZXJtaXNzaW9uOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICghIXBlcm1pc3Npb25zLnJlZGlyZWN0VG8gJiYgcGVybWlzc2lvbnMucmVkaXJlY3RUb1tmYWlsZWRQZXJtaXNzaW9uXSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjaGVja09ubHlQZXJtaXNzaW9ucyhcbiAgICAgICAgcHVyZVBlcm1pc3Npb25zOiBOZ3hQZXJtaXNzaW9uc0RhdGEsXG4gICAgICAgIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90IHwgUm91dGUsXG4gICAgICAgIHN0YXRlPzogUm91dGVyU3RhdGVTbmFwc2hvdFxuICAgICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBjb25zdCBwZXJtaXNzaW9uczogTmd4UGVybWlzc2lvbnNEYXRhID0ge1xuICAgICAgICAgICAgLi4ucHVyZVBlcm1pc3Npb25zXG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgIHRoaXMucGVybWlzc2lvbnNTZXJ2aWNlLmhhc1Blcm1pc3Npb24ocGVybWlzc2lvbnMub25seSksXG4gICAgICAgICAgICB0aGlzLnJvbGVzU2VydmljZS5oYXNPbmx5Um9sZXMocGVybWlzc2lvbnMub25seSlcbiAgICAgICAgXSkudGhlbigoW2hhc1Blcm1pc3Npb24sIGhhc1JvbGVdKSA9PiB7XG4gICAgICAgICAgICBpZiAoaGFzUGVybWlzc2lvbiB8fCBoYXNSb2xlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWRpcmVjdFRvQW5vdGhlclJvdXRlKHBlcm1pc3Npb25zLnJlZGlyZWN0VG8sIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwYXNzaW5nT25seVBlcm1pc3Npb25zVmFsaWRhdGlvbihcbiAgICAgICAgcGVybWlzc2lvbnM6IE5neFBlcm1pc3Npb25zRGF0YSxcbiAgICAgICAgcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgfCBSb3V0ZSxcbiAgICAgICAgc3RhdGU/OiBSb3V0ZXJTdGF0ZVNuYXBzaG90XG4gICAgKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIChpc0Z1bmN0aW9uPFJlZGlyZWN0VG9Gbj4ocGVybWlzc2lvbnMucmVkaXJlY3RUbylcbiAgICAgICAgICAgICAgICB8fCBpc1BsYWluT2JqZWN0KHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pICYmICF0aGlzLmlzUmVkaXJlY3Rpb25XaXRoUGFyYW1ldGVycyhwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKSlcbiAgICAgICAgKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5vbmx5UmVkaXJlY3RDaGVjayhwZXJtaXNzaW9ucywgcm91dGUsIHN0YXRlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5jaGVja09ubHlQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucywgcm91dGUsIHN0YXRlKTtcbiAgICB9XG59XG4iXX0=