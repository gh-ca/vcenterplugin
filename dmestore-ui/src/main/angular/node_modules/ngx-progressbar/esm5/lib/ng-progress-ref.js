import { __assign, __read } from "tslib";
import { Subject, BehaviorSubject, timer, of, combineLatest, Subscription, EMPTY } from 'rxjs';
import { tap, delay, debounce, switchMap, takeUntil, finalize, filter } from 'rxjs/operators';
var NgProgressRef = /** @class */ (function () {
    function NgProgressRef(customConfig, _onDestroyCallback) {
        var _this = this;
        this._onDestroyCallback = _onDestroyCallback;
        // Progress start source event (used to cancel finalizing delays)
        this._started = new Subject();
        // Progress start event: stream that emits only when it hasn't already started
        this.started = this._started.pipe(filter(function () { return !_this.isStarted; }));
        // Progress ended source event
        this._completed = new Subject();
        // Progress start event: stream that emits only when it has already started
        this.completed = this._completed.pipe(filter(function () { return _this.isStarted; }));
        // Stream that increments and updates the progress state
        this._trickling = new Subject();
        // Stream that combines "_trickling" and "config" streams
        this._worker = Subscription.EMPTY;
        this._state = new BehaviorSubject({ active: false, value: 0 });
        this._config = new BehaviorSubject(customConfig);
        this.state = this._state.asObservable();
        this.config = this._state.asObservable();
        this._worker = combineLatest(this._trickling, this._config).pipe(debounce(function (_a) {
            var _b = __read(_a, 2), start = _b[0], config = _b[1];
            return timer(start ? config.debounceTime : 0);
        }), switchMap(function (_a) {
            var _b = __read(_a, 2), start = _b[0], config = _b[1];
            return start ? _this.onTrickling(config) : _this.onComplete(config);
        })).subscribe();
    }
    Object.defineProperty(NgProgressRef.prototype, "currState", {
        // Get current progress state
        get: function () {
            return this._state.value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NgProgressRef.prototype, "isStarted", {
        // Check if progress has started
        get: function () {
            return this.currState.active;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Start the progress
     */
    NgProgressRef.prototype.start = function () {
        this._started.next();
        this._trickling.next(true);
    };
    /**
     * Complete the progress
     */
    NgProgressRef.prototype.complete = function () {
        this._trickling.next(false);
    };
    /**
     * Increment the progress
     */
    NgProgressRef.prototype.inc = function (amount) {
        var n = this.currState.value;
        if (!this.isStarted) {
            this.start();
        }
        else {
            if (typeof amount !== 'number') {
                amount = this._config.value.trickleFunc(n);
            }
            this.set(n + amount);
        }
    };
    /**
     * Set the progress
     */
    NgProgressRef.prototype.set = function (n) {
        this.setState({ value: this.clamp(n), active: true });
    };
    /**
     * Set config
     */
    NgProgressRef.prototype.setConfig = function (config) {
        this._config.next(__assign(__assign({}, this._config.value), config));
    };
    /**
     * Destroy progress reference
     */
    NgProgressRef.prototype.destroy = function () {
        this._worker.unsubscribe();
        this._trickling.complete();
        this._state.complete();
        this._config.complete();
        this._started.complete();
        this._completed.complete();
        this._onDestroyCallback();
    };
    /**
     * Set progress state
     */
    NgProgressRef.prototype.setState = function (state) {
        this._state.next(__assign(__assign({}, this.currState), state));
    };
    /**
     * Clamps a value to be between min and max
     */
    NgProgressRef.prototype.clamp = function (n) {
        return Math.max(this._config.value.min, Math.min(this._config.value.max, n));
    };
    /**
     * Keeps incrementing the progress
     */
    NgProgressRef.prototype.onTrickling = function (config) {
        var _this = this;
        if (!this.isStarted) {
            this.set(this._config.value.min);
        }
        return timer(0, config.trickleSpeed).pipe(tap(function () { return _this.inc(); }));
    };
    /**
     * Completes then resets the progress
     */
    NgProgressRef.prototype.onComplete = function (config) {
        var _this = this;
        this._completed.next();
        return !this.isStarted ? EMPTY : of({}).pipe(
        // Complete the progress
        tap(function () { return _this.setState({ value: 100 }); }), 
        // Deactivate the progress after a tiny delay
        delay(config.speed * 1.7), tap(function () { return _this.setState({ active: false }); }), 
        // Use a tiny delay before resetting
        delay(config.speed), 
        // Force the progress to reset even it got cancelled
        finalize(function () { return _this.setState({ value: 0 }); }), 
        // Cancel any of the finalizing delays if the progress has started again
        takeUntil(this._started));
    };
    return NgProgressRef;
}());
export { NgProgressRef };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctcHJvZ3Jlc3MtcmVmLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXByb2dyZXNzYmFyLyIsInNvdXJjZXMiOlsibGliL25nLXByb2dyZXNzLXJlZi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFjLE9BQU8sRUFBRSxlQUFlLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzRyxPQUFPLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHOUY7SUFvQ0UsdUJBQVksWUFBOEIsRUFBVSxrQkFBOEI7UUFBbEYsaUJBVUM7UUFWbUQsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFZO1FBMUJsRixpRUFBaUU7UUFDaEQsYUFBUSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7UUFDMUMsOEVBQThFO1FBQ3JFLFlBQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBTSxPQUFBLENBQUMsS0FBSSxDQUFDLFNBQVMsRUFBZixDQUFlLENBQUMsQ0FBQyxDQUFDO1FBRXJFLDhCQUE4QjtRQUNiLGVBQVUsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQzVDLDJFQUEyRTtRQUNsRSxjQUFTLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGNBQU0sT0FBQSxLQUFJLENBQUMsU0FBUyxFQUFkLENBQWMsQ0FBQyxDQUFDLENBQUM7UUFFeEUsd0RBQXdEO1FBQ3ZDLGVBQVUsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBRTVDLHlEQUF5RDtRQUN4QyxZQUFPLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQztRQWE1QyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksZUFBZSxDQUFr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VSxHQUFsQixVQUFtQixNQUF3QjtRQUEzQyxpQkFpQkM7UUFoQkMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN2QixPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSTtRQUMxQyx3QkFBd0I7UUFDeEIsR0FBRyxDQUFDLGNBQU0sT0FBQSxLQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQTdCLENBQTZCLENBQUM7UUFFeEMsNkNBQTZDO1FBQzdDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQyxFQUN6QixHQUFHLENBQUMsY0FBTSxPQUFBLEtBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBaEMsQ0FBZ0MsQ0FBQztRQUUzQyxvQ0FBb0M7UUFDcEMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7UUFDbkIsb0RBQW9EO1FBQ3BELFFBQVEsQ0FBQyxjQUFNLE9BQUEsS0FBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUEzQixDQUEyQixDQUFDO1FBQzNDLHdFQUF3RTtRQUN4RSxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUN6QixDQUFDO0lBQ0osQ0FBQztJQUNILG9CQUFDO0FBQUQsQ0FBQyxBQXRKRCxJQXNKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIEJlaGF2aW9yU3ViamVjdCwgdGltZXIsIG9mLCBjb21iaW5lTGF0ZXN0LCBTdWJzY3JpcHRpb24sIEVNUFRZIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YXAsIGRlbGF5LCBkZWJvdW5jZSwgc3dpdGNoTWFwLCB0YWtlVW50aWwsIGZpbmFsaXplLCBmaWx0ZXIgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBOZ1Byb2dyZXNzU3RhdGUsIE5nUHJvZ3Jlc3NDb25maWcgfSBmcm9tICcuL25nLXByb2dyZXNzLmludGVyZmFjZSc7XG5cbmV4cG9ydCBjbGFzcyBOZ1Byb2dyZXNzUmVmIHtcblxuICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHByb2dyZXNzIHN0YXRlIGlzIGNoYW5nZWRcbiAgcHJpdmF0ZSByZWFkb25seSBfc3RhdGU6IEJlaGF2aW9yU3ViamVjdDxOZ1Byb2dyZXNzU3RhdGU+O1xuICBzdGF0ZTogT2JzZXJ2YWJsZTxOZ1Byb2dyZXNzU3RhdGU+O1xuXG4gIC8vIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gY29uZmlnIGlzIGNoYW5nZWRcbiAgcHJpdmF0ZSByZWFkb25seSBfY29uZmlnOiBCZWhhdmlvclN1YmplY3Q8TmdQcm9ncmVzc0NvbmZpZz47XG4gIGNvbmZpZzogT2JzZXJ2YWJsZTxOZ1Byb2dyZXNzU3RhdGU+O1xuXG4gIC8vIFByb2dyZXNzIHN0YXJ0IHNvdXJjZSBldmVudCAodXNlZCB0byBjYW5jZWwgZmluYWxpemluZyBkZWxheXMpXG4gIHByaXZhdGUgcmVhZG9ubHkgX3N0YXJ0ZWQgPSBuZXcgU3ViamVjdCgpO1xuICAvLyBQcm9ncmVzcyBzdGFydCBldmVudDogc3RyZWFtIHRoYXQgZW1pdHMgb25seSB3aGVuIGl0IGhhc24ndCBhbHJlYWR5IHN0YXJ0ZWRcbiAgcmVhZG9ubHkgc3RhcnRlZCA9IHRoaXMuX3N0YXJ0ZWQucGlwZShmaWx0ZXIoKCkgPT4gIXRoaXMuaXNTdGFydGVkKSk7XG5cbiAgLy8gUHJvZ3Jlc3MgZW5kZWQgc291cmNlIGV2ZW50XG4gIHByaXZhdGUgcmVhZG9ubHkgX2NvbXBsZXRlZCA9IG5ldyBTdWJqZWN0KCk7XG4gIC8vIFByb2dyZXNzIHN0YXJ0IGV2ZW50OiBzdHJlYW0gdGhhdCBlbWl0cyBvbmx5IHdoZW4gaXQgaGFzIGFscmVhZHkgc3RhcnRlZFxuICByZWFkb25seSBjb21wbGV0ZWQgPSB0aGlzLl9jb21wbGV0ZWQucGlwZShmaWx0ZXIoKCkgPT4gdGhpcy5pc1N0YXJ0ZWQpKTtcblxuICAvLyBTdHJlYW0gdGhhdCBpbmNyZW1lbnRzIGFuZCB1cGRhdGVzIHRoZSBwcm9ncmVzcyBzdGF0ZVxuICBwcml2YXRlIHJlYWRvbmx5IF90cmlja2xpbmcgPSBuZXcgU3ViamVjdCgpO1xuXG4gIC8vIFN0cmVhbSB0aGF0IGNvbWJpbmVzIFwiX3RyaWNrbGluZ1wiIGFuZCBcImNvbmZpZ1wiIHN0cmVhbXNcbiAgcHJpdmF0ZSByZWFkb25seSBfd29ya2VyID0gU3Vic2NyaXB0aW9uLkVNUFRZO1xuXG4gIC8vIEdldCBjdXJyZW50IHByb2dyZXNzIHN0YXRlXG4gIHByaXZhdGUgZ2V0IGN1cnJTdGF0ZSgpOiBOZ1Byb2dyZXNzU3RhdGUge1xuICAgIHJldHVybiB0aGlzLl9zdGF0ZS52YWx1ZTtcbiAgfVxuXG4gIC8vIENoZWNrIGlmIHByb2dyZXNzIGhhcyBzdGFydGVkXG4gIGdldCBpc1N0YXJ0ZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuY3VyclN0YXRlLmFjdGl2ZTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKGN1c3RvbUNvbmZpZzogTmdQcm9ncmVzc0NvbmZpZywgcHJpdmF0ZSBfb25EZXN0cm95Q2FsbGJhY2s6ICgpID0+IHZvaWQpIHtcbiAgICB0aGlzLl9zdGF0ZSA9IG5ldyBCZWhhdmlvclN1YmplY3Q8TmdQcm9ncmVzc1N0YXRlPih7IGFjdGl2ZTogZmFsc2UsIHZhbHVlOiAwIH0pO1xuICAgIHRoaXMuX2NvbmZpZyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8TmdQcm9ncmVzc0NvbmZpZz4oY3VzdG9tQ29uZmlnKTtcbiAgICB0aGlzLnN0YXRlID0gdGhpcy5fc3RhdGUuYXNPYnNlcnZhYmxlKCk7XG4gICAgdGhpcy5jb25maWcgPSB0aGlzLl9zdGF0ZS5hc09ic2VydmFibGUoKTtcblxuICAgIHRoaXMuX3dvcmtlciA9IGNvbWJpbmVMYXRlc3QodGhpcy5fdHJpY2tsaW5nLCB0aGlzLl9jb25maWcpLnBpcGUoXG4gICAgICBkZWJvdW5jZSgoW3N0YXJ0LCBjb25maWddOiBbYm9vbGVhbiwgTmdQcm9ncmVzc0NvbmZpZ10pID0+IHRpbWVyKHN0YXJ0ID8gY29uZmlnLmRlYm91bmNlVGltZSA6IDApKSxcbiAgICAgIHN3aXRjaE1hcCgoW3N0YXJ0LCBjb25maWddOiBbYm9vbGVhbiwgTmdQcm9ncmVzc0NvbmZpZ10pID0+IHN0YXJ0ID8gdGhpcy5vblRyaWNrbGluZyhjb25maWcpIDogdGhpcy5vbkNvbXBsZXRlKGNvbmZpZykpXG4gICAgKS5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydCB0aGUgcHJvZ3Jlc3NcbiAgICovXG4gIHN0YXJ0KCkge1xuICAgIHRoaXMuX3N0YXJ0ZWQubmV4dCgpO1xuICAgIHRoaXMuX3RyaWNrbGluZy5uZXh0KHRydWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbXBsZXRlIHRoZSBwcm9ncmVzc1xuICAgKi9cbiAgY29tcGxldGUoKSB7XG4gICAgdGhpcy5fdHJpY2tsaW5nLm5leHQoZmFsc2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIEluY3JlbWVudCB0aGUgcHJvZ3Jlc3NcbiAgICovXG4gIGluYyhhbW91bnQ/OiBudW1iZXIpIHtcbiAgICBjb25zdCBuID0gdGhpcy5jdXJyU3RhdGUudmFsdWU7XG4gICAgaWYgKCF0aGlzLmlzU3RhcnRlZCkge1xuICAgICAgdGhpcy5zdGFydCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodHlwZW9mIGFtb3VudCAhPT0gJ251bWJlcicpIHtcbiAgICAgICAgYW1vdW50ID0gdGhpcy5fY29uZmlnLnZhbHVlLnRyaWNrbGVGdW5jKG4pO1xuICAgICAgfVxuICAgICAgdGhpcy5zZXQobiArIGFtb3VudCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNldCB0aGUgcHJvZ3Jlc3NcbiAgICovXG4gIHNldChuOiBudW1iZXIpIHtcbiAgICB0aGlzLnNldFN0YXRlKHsgdmFsdWU6IHRoaXMuY2xhbXAobiksIGFjdGl2ZTogdHJ1ZSB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgY29uZmlnXG4gICAqL1xuICBzZXRDb25maWcoY29uZmlnOiBOZ1Byb2dyZXNzQ29uZmlnKSB7XG4gICAgdGhpcy5fY29uZmlnLm5leHQoeyAuLi50aGlzLl9jb25maWcudmFsdWUsIC4uLmNvbmZpZyB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZXN0cm95IHByb2dyZXNzIHJlZmVyZW5jZVxuICAgKi9cbiAgZGVzdHJveSgpIHtcbiAgICB0aGlzLl93b3JrZXIudW5zdWJzY3JpYmUoKTtcbiAgICB0aGlzLl90cmlja2xpbmcuY29tcGxldGUoKTtcbiAgICB0aGlzLl9zdGF0ZS5jb21wbGV0ZSgpO1xuICAgIHRoaXMuX2NvbmZpZy5jb21wbGV0ZSgpO1xuICAgIHRoaXMuX3N0YXJ0ZWQuY29tcGxldGUoKTtcbiAgICB0aGlzLl9jb21wbGV0ZWQuY29tcGxldGUoKTtcbiAgICB0aGlzLl9vbkRlc3Ryb3lDYWxsYmFjaygpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBwcm9ncmVzcyBzdGF0ZVxuICAgKi9cbiAgcHJpdmF0ZSBzZXRTdGF0ZShzdGF0ZTogTmdQcm9ncmVzc1N0YXRlKSB7XG4gICAgdGhpcy5fc3RhdGUubmV4dCh7IC4uLnRoaXMuY3VyclN0YXRlLCAuLi5zdGF0ZSB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGFtcHMgYSB2YWx1ZSB0byBiZSBiZXR3ZWVuIG1pbiBhbmQgbWF4XG4gICAqL1xuICBwcml2YXRlIGNsYW1wKG46IG51bWJlcik6IG51bWJlciB7XG4gICAgcmV0dXJuIE1hdGgubWF4KHRoaXMuX2NvbmZpZy52YWx1ZS5taW4sIE1hdGgubWluKHRoaXMuX2NvbmZpZy52YWx1ZS5tYXgsIG4pKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBLZWVwcyBpbmNyZW1lbnRpbmcgdGhlIHByb2dyZXNzXG4gICAqL1xuICBwcml2YXRlIG9uVHJpY2tsaW5nKGNvbmZpZzogTmdQcm9ncmVzc0NvbmZpZyk6IE9ic2VydmFibGU8bnVtYmVyPiB7XG4gICAgaWYgKCF0aGlzLmlzU3RhcnRlZCkge1xuICAgICAgdGhpcy5zZXQodGhpcy5fY29uZmlnLnZhbHVlLm1pbik7XG4gICAgfVxuICAgIHJldHVybiB0aW1lcigwLCBjb25maWcudHJpY2tsZVNwZWVkKS5waXBlKHRhcCgoKSA9PiB0aGlzLmluYygpKSk7XG4gIH1cblxuICAvKipcbiAgICogQ29tcGxldGVzIHRoZW4gcmVzZXRzIHRoZSBwcm9ncmVzc1xuICAgKi9cbiAgcHJpdmF0ZSBvbkNvbXBsZXRlKGNvbmZpZzogTmdQcm9ncmVzc0NvbmZpZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgdGhpcy5fY29tcGxldGVkLm5leHQoKTtcbiAgICByZXR1cm4gIXRoaXMuaXNTdGFydGVkID8gRU1QVFkgOiBvZih7fSkucGlwZShcbiAgICAgIC8vIENvbXBsZXRlIHRoZSBwcm9ncmVzc1xuICAgICAgdGFwKCgpID0+IHRoaXMuc2V0U3RhdGUoeyB2YWx1ZTogMTAwIH0pKSxcblxuICAgICAgLy8gRGVhY3RpdmF0ZSB0aGUgcHJvZ3Jlc3MgYWZ0ZXIgYSB0aW55IGRlbGF5XG4gICAgICBkZWxheShjb25maWcuc3BlZWQgKiAxLjcpLFxuICAgICAgdGFwKCgpID0+IHRoaXMuc2V0U3RhdGUoeyBhY3RpdmU6IGZhbHNlIH0pKSxcblxuICAgICAgLy8gVXNlIGEgdGlueSBkZWxheSBiZWZvcmUgcmVzZXR0aW5nXG4gICAgICBkZWxheShjb25maWcuc3BlZWQpLFxuICAgICAgLy8gRm9yY2UgdGhlIHByb2dyZXNzIHRvIHJlc2V0IGV2ZW4gaXQgZ290IGNhbmNlbGxlZFxuICAgICAgZmluYWxpemUoKCkgPT4gdGhpcy5zZXRTdGF0ZSh7IHZhbHVlOiAwIH0pKSxcbiAgICAgIC8vIENhbmNlbCBhbnkgb2YgdGhlIGZpbmFsaXppbmcgZGVsYXlzIGlmIHRoZSBwcm9ncmVzcyBoYXMgc3RhcnRlZCBhZ2FpblxuICAgICAgdGFrZVVudGlsKHRoaXMuX3N0YXJ0ZWQpXG4gICAgKTtcbiAgfVxufVxuIl19