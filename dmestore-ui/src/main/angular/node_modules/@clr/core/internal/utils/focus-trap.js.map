{"version":3,"file":"focus-trap.js","sourceRoot":"","sources":["../../../../src/internal/utils/focus-trap.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright (c) 2016-2020 VMware, Inc. All Rights Reserved.\n * This software is released under MIT license.\n * The full license information can be found in LICENSE in the root directory of this project.\n */\n\nimport { FocusTrapTracker } from '../services/focus-trap-tracker.service.js';\nimport { addAttributeValue, isHTMLElement, removeAttributeValue } from './dom.js';\n\nexport interface FocusTrapElement extends HTMLElement {\n  topReboundElement: HTMLElement;\n  bottomReboundElement: HTMLElement;\n}\n\nexport function focusElementIfInCurrentFocusTrapElement(\n  focusedElement: HTMLElement,\n  focusTrapElement: FocusTrapElement\n) {\n  if (\n    FocusTrapTracker.getCurrent() === focusTrapElement &&\n    elementIsOutsideFocusTrapElement(focusedElement, focusTrapElement)\n  ) {\n    focusTrapElement.focus();\n  }\n}\n\nexport function elementIsOutsideFocusTrapElement(focusedElement: HTMLElement, focusTrapElement: FocusTrapElement) {\n  return (\n    !focusTrapElement.contains(focusedElement) ||\n    focusedElement === focusTrapElement.topReboundElement ||\n    focusedElement === focusTrapElement.bottomReboundElement\n  );\n}\n\nexport function createFocusTrapReboundElement() {\n  const offScreenSpan = document.createElement('span');\n  offScreenSpan.setAttribute('tabindex', '0');\n  offScreenSpan.classList.add('offscreen-focus-rebounder');\n  return offScreenSpan;\n}\n\nexport function addReboundElementsToFocusTrapElement(focusTrapElement: FocusTrapElement) {\n  if (focusTrapElement) {\n    focusTrapElement.topReboundElement = createFocusTrapReboundElement();\n    focusTrapElement.bottomReboundElement = createFocusTrapReboundElement();\n\n    if (focusTrapElement.parentElement) {\n      focusTrapElement.parentElement.insertBefore(focusTrapElement.topReboundElement, focusTrapElement);\n      if (focusTrapElement.nextSibling) {\n        focusTrapElement.parentElement.insertBefore(\n          focusTrapElement.bottomReboundElement,\n          focusTrapElement.nextSibling\n        );\n      } else {\n        focusTrapElement.parentElement.appendChild(focusTrapElement.bottomReboundElement);\n      }\n    }\n  }\n}\n\nexport function removeReboundElementsFromFocusTrapElement(focusTrapElement: FocusTrapElement) {\n  if (focusTrapElement) {\n    if (focusTrapElement.topReboundElement && focusTrapElement.parentElement) {\n      focusTrapElement.parentElement.removeChild(focusTrapElement.topReboundElement);\n    }\n    if (focusTrapElement.bottomReboundElement && focusTrapElement.parentElement) {\n      focusTrapElement.parentElement.removeChild(focusTrapElement.bottomReboundElement);\n    }\n    // These are here to to make sure that we completely delete all traces of the removed DOM objects.\n    delete focusTrapElement.topReboundElement;\n    delete focusTrapElement.bottomReboundElement;\n  }\n}\nexport class FocusTrap {\n  private focusTrapElement: FocusTrapElement;\n  private previousFocus: HTMLElement;\n  private onFocusInEvent: any;\n\n  constructor(hostElement: HTMLElement) {\n    this.focusTrapElement = hostElement as FocusTrapElement;\n  }\n\n  enableFocusTrap() {\n    if (FocusTrapTracker.getCurrent() === this.focusTrapElement) {\n      throw new Error('Focus trap is already enabled for this instance.');\n    }\n\n    addReboundElementsToFocusTrapElement(this.focusTrapElement);\n    this.focusTrapElement.setAttribute('tabindex', '0');\n    if (document.activeElement && isHTMLElement(document.activeElement)) {\n      this.previousFocus = document.activeElement as HTMLElement;\n    }\n    addAttributeValue(document.body, 'cds-layout', 'no-scrolling');\n    FocusTrapTracker.setCurrent(this.focusTrapElement);\n    this.focusTrapElement.focus();\n    this.onFocusInEvent = this.onFocusIn.bind(this);\n    document.addEventListener('focusin', this.onFocusInEvent);\n  }\n\n  removeFocusTrap() {\n    document.removeEventListener('focusin', this.onFocusInEvent);\n    removeAttributeValue(document.body, 'cds-layout', 'no-scrolling');\n    removeReboundElementsFromFocusTrapElement(this.focusTrapElement);\n    FocusTrapTracker.activatePreviousCurrent();\n    if (this.previousFocus) {\n      this.previousFocus.focus();\n    }\n  }\n\n  private onFocusIn(event: FocusEvent) {\n    focusElementIfInCurrentFocusTrapElement(event.target as HTMLElement, this.focusTrapElement);\n  }\n}\n"]}